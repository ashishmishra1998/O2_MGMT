{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics - O2 Bottle Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .metric-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .trend-indicator {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>Sales Analytics
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="{% url 'admin_dashboard' %}">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'client_list' %}">Clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'inventory' %}">Inventory</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'pricing' %}">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{% url 'sales_analytics' %}">Sales Analytics</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-chart-bar me-2"></i>Sales Analytics Dashboard</h2>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="yearFilter" style="width: 100px;">
                            {% for year in year_range %}
                                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select form-select-sm" id="monthFilter" style="width: 120px;">
                            <option value="1" {% if selected_month == 1 %}selected{% endif %}>January</option>
                            <option value="2" {% if selected_month == 2 %}selected{% endif %}>February</option>
                            <option value="3" {% if selected_month == 3 %}selected{% endif %}>March</option>
                            <option value="4" {% if selected_month == 4 %}selected{% endif %}>April</option>
                            <option value="5" {% if selected_month == 5 %}selected{% endif %}>May</option>
                            <option value="6" {% if selected_month == 6 %}selected{% endif %}>June</option>
                            <option value="7" {% if selected_month == 7 %}selected{% endif %}>July</option>
                            <option value="8" {% if selected_month == 8 %}selected{% endif %}>August</option>
                            <option value="9" {% if selected_month == 9 %}selected{% endif %}>September</option>
                            <option value="10" {% if selected_month == 10 %}selected{% endif %}>October</option>
                            <option value="11" {% if selected_month == 11 %}selected{% endif %}>November</option>
                            <option value="12" {% if selected_month == 12 %}selected{% endif %}>December</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Cards -->
        <div class="row mb-4">
            <!-- Daily Sales -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-value">₹{{ daily_sales.total_amount|floatformat:0 }}</div>
                                <div class="metric-label">Today's Sales</div>
                                <small>{{ daily_sales.total_bills }} bills</small>
                            </div>
                            <div class="metric-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Sales -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-value">₹{{ weekly_sales.total_amount|floatformat:0 }}</div>
                                <div class="metric-label">This Week</div>
                                <small>{{ weekly_sales.total_bills }} bills</small>
                            </div>
                            <div class="metric-icon">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Sales -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-value">₹{{ monthly_sales.total_amount|floatformat:0 }}</div>
                                <div class="metric-label">This Month</div>
                                <small>{{ monthly_sales.total_bills }} bills</small>
                            </div>
                            <div class="metric-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yearly Sales -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-value">₹{{ yearly_sales.total_amount|floatformat:0 }}</div>
                                <div class="metric-label">This Year</div>
                                <small>{{ yearly_sales.total_bills }} bills</small>
                            </div>
                            <div class="metric-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Status and Payment Analytics -->
        <div class="row mb-4">
            <!-- Stock Status -->
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Current Stock Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="progress-circle bg-success text-white">
                                    {{ in_stock }}
                                </div>
                                <div class="mt-2">
                                    <strong>In Stock</strong><br>
                                    <small class="text-muted">{{ in_stock_percent }}%</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="progress-circle bg-warning text-dark">
                                    {{ delivered_stock }}
                                </div>
                                <div class="mt-2">
                                    <strong>Delivered</strong><br>
                                    <small class="text-muted">{{ delivered_percent }}%</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="progress-circle bg-info text-white">
                                    {{ returned_stock }}
                                </div>
                                <div class="mt-2">
                                    <strong>Returned</strong><br>
                                    <small class="text-muted">{{ returned_percent }}%</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: {{ in_stock_percent }}%"></div>
                                <div class="progress-bar bg-warning" style="width: {{ delivered_percent }}%"></div>
                                <div class="progress-bar bg-info" style="width: {{ returned_percent }}%"></div>
                            </div>
                            <small class="text-muted">Total Stock: {{ total_stock }} bottles</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Analytics -->
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Payment Analytics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <h3 class="text-success">₹{{ selected_sales.paid_amount|floatformat:0 }}</h3>
                                    <small class="text-muted">Paid Amount</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h3 class="text-danger">₹{{ selected_sales.unpaid_amount|floatformat:0 }}</h3>
                                    <small class="text-muted">Pending Amount</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Payment Rate</span>
                                <span>{{ selected_sales.payment_rate|floatformat:1 }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: {{ selected_sales.payment_rate }}%"></div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <h5>{{ selected_sales.total_bottles_delivered }}</h5>
                                    <small class="text-muted">Delivered</small>
                                </div>
                                <div class="col-4">
                                    <h5>{{ selected_sales.total_bottles_returned }}</h5>
                                    <small class="text-muted">Returned</small>
                                </div>
                                <div class="col-4">
                                    <h5>{{ selected_sales.total_pending_bottles }}</h5>
                                    <small class="text-muted">Pending</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Monthly Trend Chart -->
            <div class="col-lg-8 mb-3">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Sales Trend ({{ selected_year }})</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Clients -->
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top 5 Clients</h5>
                    </div>
                    <div class="card-body">
                        {% for client in top_clients %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ client.client.name }}</strong><br>
                                <small class="text-muted">{{ client.total_delivered }} delivered, {{ client.total_pending }} pending</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-success">₹{{ client.total_amount|floatformat:0 }}</strong><br>
                                <small class="text-muted">{{ client.payment_rate|floatformat:1 }}% paid</small>
                            </div>
                        </div>
                        {% if not forloop.last %}<hr>{% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Analytics Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Client-wise Analytics</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Client</th>
                                        <th>Contact</th>
                                        <th>Delivered</th>
                                        <th>Returned</th>
                                        <th>Pending</th>
                                        <th>Total Amount</th>
                                        <th>Paid</th>
                                        <th>Pending</th>
                                        <th>Payment Rate</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in client_analytics %}
                                    <tr>
                                        <td>
                                            <strong>{{ client.client.name }}</strong><br>
                                            <small class="text-muted">{{ client.client.address }}</small>
                                        </td>
                                        <td>{{ client.client.contact }}</td>
                                        <td>
                                            <span class="badge bg-success">{{ client.total_delivered }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ client.total_returned }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning">{{ client.total_pending }}</span>
                                        </td>
                                        <td>
                                            <strong>₹{{ client.total_amount|floatformat:0 }}</strong>
                                        </td>
                                        <td>
                                            <span class="text-success">₹{{ client.paid_amount|floatformat:0 }}</span>
                                        </td>
                                        <td>
                                            <span class="text-danger">₹{{ client.unpaid_amount|floatformat:0 }}</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" style="width: {{ client.payment_rate }}%">
                                                    {{ client.payment_rate|floatformat:1 }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if client.payment_rate == 100 %}
                                                <span class="status-badge bg-success text-white">Fully Paid</span>
                                            {% elif client.payment_rate > 50 %}
                                                <span class="status-badge bg-warning text-dark">Partially Paid</span>
                                            {% else %}
                                                <span class="status-badge bg-danger text-white">Unpaid</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Bill #</th>
                                        <th>Amount</th>
                                        <th>Bottles</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bill in recent_bills %}
                                    <tr>
                                        <td>{{ bill.bill_date|date:"M d, Y" }}</td>
                                        <td>{{ bill.client.name }}</td>
                                        <td>#{{ bill.id }}</td>
                                        <td><strong>₹{{ bill.total_amount|floatformat:0 }}</strong></td>
                                        <td>{{ bill.delivered_bottles }}D, {{ bill.returned_bottles }}R</td>
                                        <td>
                                            {% if bill.paid %}
                                                <span class="badge bg-success">Paid</span>
                                            {% else %}
                                                <span class="badge bg-warning">Unpaid</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Monthly Trend Chart
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        const monthlyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [{% for month in monthly_trend %}'{{ month.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Sales Amount (₹)',
                    data: [{% for month in monthly_trend %}{{ month.amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: 'Bottles Delivered',
                    data: [{% for month in monthly_trend %}{{ month.bottles }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Sales Amount (₹)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Bottles Delivered'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // Date filters
        document.getElementById('yearFilter').addEventListener('change', function() {
            const year = this.value;
            const month = document.getElementById('monthFilter').value;
            window.location.href = `?year=${year}&month=${month}`;
        });

        document.getElementById('monthFilter').addEventListener('change', function() {
            const year = document.getElementById('yearFilter').value;
            const month = this.value;
            window.location.href = `?year=${year}&month=${month}`;
        });
    </script>
</body>
</html> 